{% extends "_layout.twig" %}

{% block title %}Completed Tasks{% endblock %}

{% block content %}
<div class="tasks-container">
    <h1>Completed Tasks</h1>
    
    <div class="filter-controls">
        <input type="date" id="filter-date" class="date-input" value="{{ now|date('Y-m-d') }}">
        <div class="shift-selector">
            <button class="shift-btn active" data-shift="day">Day</button> / 
            <button class="shift-btn" data-shift="night">Night</button>
        </div>
        <button id="apply-filter" class="action-btn">Apply Filter</button>
    </div>
    
    <div class="tasks-list">
        <table class="tasks-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Transport</th>
                    <th>Time Received</th>
                    <th>Time Completed</th>
                    <th>Staff</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="completed-tasks-list">
                {% set currentDate = now|date('Y-m-d') %}
                {% set currentShift = 'day' %}
                
                {% set completedTasks = craft.entries()
                    .section('tasks')
                    .fd_status('completed')
                    .fd_date(currentDate)
                    .fd_shift(currentShift)
                    .all() %}
                
                {% if completedTasks|length > 0 %}
                    {% for task in completedTasks %}
                        <tr>
                            <td>{{ task.fd_itemType.one().title ?? 'Unknown' }}</td>
                            <td>{{ task.fd_fromDepartment.one().title ?? 'Unknown' }}</td>
                            <td>{{ task.fd_toDepartment.one().title ?? 'Unknown' }}</td>
                            <td>{{ task.fd_transportType ?? '-' }}</td>
                            <td>{{ task.fd_time_received }}</td>
                            <td>{{ task.fd_time_completed }}</td>
                            <td>{{ task.fd_staffMember.one() ? task.fd_staffMember.one().title ~ ' ' ~ task.fd_staffMember.one().fd_surname : 'Unassigned' }}</td>
                            <td class="action-cell">
                                <a href="{{ task.cpEditUrl }}" class="table-action-btn edit">Edit</a>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="empty-state">No completed tasks for this shift.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <div class="back-link">
        <a href="{{ siteUrl }}">‚Üê Back to Home</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date and shift from localStorage
    const dateInput = document.getElementById('filter-date');
    const shiftButtons = document.querySelectorAll('.shift-btn');
    let currentDate = "{{ now|date('Y-m-d') }}";
    let currentShift = "day";
    
    // Load saved date/shift from localStorage
    if (dateInput) {
        const savedDate = localStorage.getItem('currentDate');
        if (savedDate) {
            dateInput.value = savedDate;
            currentDate = savedDate;
        } else {
            localStorage.setItem('currentDate', dateInput.value);
        }
        
        dateInput.addEventListener('change', function() {
            localStorage.setItem('currentDate', this.value);
            currentDate = this.value;
        });
    }
    
    if (shiftButtons.length) {
        const savedShift = localStorage.getItem('currentShift');
        if (savedShift) {
            const activeButton = document.querySelector(`.shift-btn[data-shift="${savedShift}"]`);
            if (activeButton) {
                shiftButtons.forEach(b => b.classList.remove('active'));
                activeButton.classList.add('active');
                currentShift = savedShift;
            }
        }
        
        shiftButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                shiftButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentShift = this.dataset.shift;
                localStorage.setItem('currentShift', currentShift);
            });
        });
    }
    
    // Apply filter button
    const applyFilterBtn = document.getElementById('apply-filter');
    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', function() {
            // Reload page with new filter
            window.location.reload();
        });
    }
});
</script>
{% endblock %}
