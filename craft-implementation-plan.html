<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
</head>
<body>

<h1 id="portertaskmanagement-craftcms5.ximplementationplan">Porter Task Management - Craft CMS 5.x Implementation Plan</h1>

<h2 id="phase1:setupcraftcmsdatastructure">Phase 1: Setup Craft CMS Data Structure</h2>

<h3 id="step1:createcategorygroups">Step 1: Create Category Groups</h3>

<p>Craft CMS 5.x uses Categories as a powerful way to organize related data. For our Porter Task Management app, we&#8217;ll create four category groups:</p>

<ol>
<li><strong>Buildings</strong></li>
</ol>

<ul>
<li> Navigate to Settings → Categories → New Category Group</li>
<li> Name: Buildings</li>
<li> Handle: buildings</li>
<li> Max Levels: 1</li>
<li> Site Settings: Enable for your site(s)</li>
<li> Field Layout: Just the Title field for now</li>
</ul>

<ol>
<li><strong>Departments</strong></li>
</ol>

<ul>
<li> Name: Departments</li>
<li> Handle: departments</li>
<li> Max Levels: 1</li>
<li> Field Layout:

<ul>
<li> Title field (default)</li>
<li> Add a new Categories field:</li>
<li> Field Name: Building</li>
<li> Handle: building</li>
<li> Source: Buildings category group</li>
<li> Limit: 1 (each department belongs to one building)</li>
<li> Required: Yes</li>
</ul></li>
</ul>

<ol>
<li><strong>Job Types</strong></li>
</ol>

<ul>
<li> Name: Job Types</li>
<li> Handle: jobTypes</li>
<li> Max Levels: 1</li>
<li> Field Layout:

<ul>
<li> Title field</li>
<li> Add a new Table field:</li>
<li> Field Name: Transport Options</li>
<li> Handle: transportOptions</li>
<li> Add one column: &#8220;Option&#8221; (text)</li>
<li> Default Values: Empty (you&#8217;ll add options for the Patient Transfer job type)</li>
<li> Required: No (only needed for Patient Transfer type)</li>
</ul></li>
</ul>

<ol>
<li><strong>Job Categories</strong></li>
</ol>

<ul>
<li> Name: Job Categories</li>
<li> Handle: jobCategories</li>
<li> Max Levels: 1</li>
<li> Field Layout:

<ul>
<li> Title field</li>
<li> Add a new Categories field:</li>
<li> Field Name: Allowed Types</li>
<li> Handle: allowedTypes</li>
<li> Source: Job Types</li>
<li> Limit: No limit</li>
<li> Required: Yes</li>
</ul></li>
</ul>

<h3 id="step2:createcustomelementtypes">Step 2: Create Custom Element Types</h3>

<p>Create a module to house our custom element types. Start with:</p>

<pre><code class="bash">ddev craft make module/porter
</code></pre>

<h4 id="implementstaffelementtype">Implement Staff Element Type</h4>

<ol>
<li>Create <code>modules/porter/elements/Staff.php</code></li>
<li>Create <code>modules/porter/migrations/Install.php</code> to create the necessary database table</li>
</ol>

<h4 id="implementtaskelementtype">Implement Task Element Type</h4>

<ol>
<li>Create <code>modules/porter/elements/Task.php</code></li>
<li>Add task-related tables to the Install migration</li>
</ol>

<h3 id="step3:configuregraphqlapi">Step 3: Configure GraphQL API</h3>

<ol>
<li>Enable GraphQL in Craft settings</li>
<li>Create a schema for Porter Task Management</li>
<li>Create or generate GraphQL types for all your elements</li>
</ol>

<h2 id="phase2:updatefrontendtousecraftdata">Phase 2: Update Frontend to Use Craft Data</h2>

<h3 id="step1:createcontrolleractions">Step 1: Create Controller Actions</h3>

<ol>
<li>Create a Tasks controller in <code>modules/porter/controllers/TasksController.php</code></li>
<li>Implement actions for:</li>
</ol>

<ul>
<li> <code>actionGetPendingTasks</code></li>
<li> <code>actionGetCompletedTasks</code></li>
<li> <code>actionCreateTask</code></li>
<li> <code>actionUpdateTask</code></li>
<li> <code>actionCompleteTask</code></li>
<li> <code>actionArchiveShift</code></li>
</ul>

<h3 id="step2:updatetemplates">Step 2: Update Templates</h3>

<p>Update your templates to leverage Craft&#8217;s variables and template functions:</p>

<h4 id="example:homepageindex.twig">Example: Home Page (index.twig)</h4>

<pre><code class="twig">{% extends &quot;_layout.twig&quot; %}

{% block title %}Porter{% endblock %}

{% block content %}
&lt;div class=&quot;simple-screen&quot;&gt;
    &lt;div class=&quot;simple-header&quot;&gt;
        &lt;input type=&quot;date&quot; id=&quot;current-date&quot; class=&quot;date-input&quot; value=&quot;{{ now|date('Y-m-d') }}&quot;&gt;
        &lt;div class=&quot;shift-selector&quot;&gt;
            &lt;button class=&quot;shift-btn active&quot; data-shift=&quot;day&quot;&gt;Day&lt;/button&gt; / 
            &lt;button class=&quot;shift-btn&quot; data-shift=&quot;night&quot;&gt;Night&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;div class=&quot;main-button&quot;&gt;
        &lt;a href=&quot;{{ url('tasks/new') }}&quot; id=&quot;new-task-btn&quot;&gt;New Task&lt;/a&gt;
    &lt;/div&gt;
    
    &lt;div class=&quot;bottom-buttons&quot;&gt;
        &lt;a href=&quot;{{ url('tasks/pending') }}&quot; id=&quot;pending-tasks-btn&quot;&gt;Pending Tasks&lt;/a&gt;
        &lt;a href=&quot;{{ url('tasks/completed') }}&quot; id=&quot;completed-tasks-btn&quot;&gt;Completed Tasks&lt;/a&gt;
        &lt;button id=&quot;shift-complete-btn&quot; class=&quot;shift-btn&quot;&gt;Shift Complete&lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;
{% endblock %}

{% block scripts %}
&lt;script&gt;
// Simplified script that will call Craft controller actions
document.addEventListener('DOMContentLoaded', function() {
    // Get shift complete button
    const shiftCompleteBtn = document.getElementById('shift-complete-btn');
    
    // Add event listener
    if (shiftCompleteBtn) {
        shiftCompleteBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to complete this shift?')) {
                const currentDate = document.getElementById('current-date').value;
                const currentShift = document.querySelector('.shift-btn.active').dataset.shift;
                
                // Use Craft's CSRF token
                const csrfToken = '{{ craft.app.request.csrfToken }}';
                
                // Call Craft controller action
                fetch('/actions/porter/tasks/archive-shift', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        date: currentDate,
                        shift: currentShift
                    })
                })
                .then(response =&gt; response.json())
                .then(data =&gt; {
                    if (data.success) {
                        window.location.href = '/tasks/report';
                    } else {
                        alert('Failed to complete shift: ' + data.error);
                    }
                })
                .catch(error =&gt; {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            }
        });
    }
});
&lt;/script&gt;
{% endblock %}
</code></pre>

<h4 id="example:newtaskform">Example: New Task Form</h4>

<pre><code class="twig">{% extends &quot;_layout.twig&quot; %}

{% block title %}New Task{% endblock %}

{% block content %}
&lt;div class=&quot;new-task-form&quot;&gt;
    &lt;form method=&quot;post&quot; action=&quot;&quot; accept-charset=&quot;UTF-8&quot;&gt;
        {{ csrfInput() }}
        &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;porter/tasks/create-task&quot;&gt;
        &lt;input type=&quot;hidden&quot; name=&quot;redirect&quot; value=&quot;tasks/pending&quot;&gt;
        
        &lt;div class=&quot;form-group&quot;&gt;
            &lt;label for=&quot;time-received&quot;&gt;Time Received:&lt;/label&gt;
            &lt;input type=&quot;time&quot; id=&quot;time-received&quot; name=&quot;timeReceived&quot; value=&quot;{{ now|date('H:i') }}&quot; required&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;form-group&quot;&gt;
            &lt;label for=&quot;job-category&quot;&gt;Job Category:&lt;/label&gt;
            &lt;select id=&quot;job-category&quot; name=&quot;jobCategoryId&quot; required&gt;
                &lt;option value=&quot;&quot;&gt;Select Job Category&lt;/option&gt;
                {% for category in craft.categories.group('jobCategories').all() %}
                    &lt;option value=&quot;{{ category.id }}&quot;&gt;{{ category.title }}&lt;/option&gt;
                {% endfor %}
            &lt;/select&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;form-group&quot;&gt;
            &lt;label for=&quot;from-department&quot;&gt;From Department:&lt;/label&gt;
            &lt;select id=&quot;from-department&quot; name=&quot;fromDepartmentId&quot; required&gt;
                &lt;option value=&quot;&quot;&gt;Select Department&lt;/option&gt;
                {% for department in craft.categories.group('departments').all() %}
                    &lt;option value=&quot;{{ department.id }}&quot;&gt;{{ department.title }}&lt;/option&gt;
                {% endfor %}
            &lt;/select&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;form-group&quot;&gt;
            &lt;label for=&quot;to-department&quot;&gt;To Department:&lt;/label&gt;
            &lt;select id=&quot;to-department&quot; name=&quot;toDepartmentId&quot; required&gt;
                &lt;option value=&quot;&quot;&gt;Select Department&lt;/option&gt;
                {% for department in craft.categories.group('departments').all() %}
                    &lt;option value=&quot;{{ department.id }}&quot;&gt;{{ department.title }}&lt;/option&gt;
                {% endfor %}
            &lt;/select&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;form-group&quot;&gt;
            &lt;label for=&quot;item-type&quot;&gt;Item Type:&lt;/label&gt;
            &lt;select id=&quot;item-type&quot; name=&quot;itemTypeId&quot; required&gt;
                &lt;option value=&quot;&quot;&gt;Select Item Type&lt;/option&gt;
                &lt;!-- Job types will be populated by JavaScript --&gt;
            &lt;/select&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;form-group&quot; id=&quot;transport-container&quot; style=&quot;display: none;&quot;&gt;
            &lt;label for=&quot;transport-type&quot;&gt;Transport Type:&lt;/label&gt;
            &lt;select id=&quot;transport-type&quot; name=&quot;transportType&quot;&gt;
                &lt;option value=&quot;&quot;&gt;Select Transport Type&lt;/option&gt;
                &lt;!-- Transport options will be populated by JavaScript --&gt;
            &lt;/select&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;form-actions&quot;&gt;
            &lt;button type=&quot;submit&quot; name=&quot;status&quot; value=&quot;pending&quot; class=&quot;secondary-btn&quot;&gt;Save as Pending&lt;/button&gt;
            &lt;button type=&quot;submit&quot; name=&quot;status&quot; value=&quot;completed&quot; class=&quot;primary-btn&quot;&gt;Mark as Complete&lt;/button&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/div&gt;
{% endblock %}

{% block scripts %}
&lt;script&gt;
document.addEventListener('DOMContentLoaded', function() {
    const jobCategorySelect = document.getElementById('job-category');
    const itemTypeSelect = document.getElementById('item-type');
    const transportContainer = document.getElementById('transport-container');
    const transportTypeSelect = document.getElementById('transport-type');
    
    // Load allowed job types when job category changes
    if (jobCategorySelect) {
        jobCategorySelect.addEventListener('change', function() {
            const categoryId = this.value;
            if (!categoryId) return;
            
            fetch(`/actions/porter/tasks/get-job-types?categoryId=${categoryId}`)
                .then(response =&gt; response.json())
                .then(data =&gt; {
                    // Clear existing options
                    itemTypeSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;Select Item Type&lt;/option&gt;';
                    
                    // Add new options
                    data.jobTypes.forEach(jobType =&gt; {
                        const option = document.createElement('option');
                        option.value = jobType.id;
                        option.textContent = jobType.title;
                        option.dataset.hasTransport = jobType.hasTransportOptions ? 'true' : 'false';
                        itemTypeSelect.appendChild(option);
                    });
                });
        });
    }
    
    // Show/hide transport options based on job type
    if (itemTypeSelect) {
        itemTypeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const hasTransport = selectedOption.dataset.hasTransport === 'true';
            
            if (hasTransport) {
                transportContainer.style.display = 'block';
                
                // Load transport options
                fetch(`/actions/porter/tasks/get-transport-options?jobTypeId=${this.value}`)
                    .then(response =&gt; response.json())
                    .then(data =&gt; {
                        // Clear existing options
                        transportTypeSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;Select Transport Type&lt;/option&gt;';
                        
                        // Add new options
                        data.transportOptions.forEach(option =&gt; {
                            const optionEl = document.createElement('option');
                            optionEl.value = option;
                            optionEl.textContent = option;
                            transportTypeSelect.appendChild(optionEl);
                        });
                    });
            } else {
                transportContainer.style.display = 'none';
            }
        });
    }
});
&lt;/script&gt;
{% endblock %}
</code></pre>

<h3 id="step3:createjavascriptforapiinteraction">Step 3: Create JavaScript for API Interaction</h3>

<p>Replace your mock-data.js with a new craft-api.js that communicates with Craft&#8217;s controller actions:</p>

<pre><code class="javascript">// craft-api.js
class PorterApi {
    // Get pending tasks for a date and shift
    async getPendingTasks(date, shift) {
        const response = await fetch(`/actions/porter/tasks/get-pending-tasks?date=${date}&amp;shift=${shift}`);
        return await response.json();
    }
    
    // Get completed tasks for a date and shift
    async getCompletedTasks(date, shift) {
        const response = await fetch(`/actions/porter/tasks/get-completed-tasks?date=${date}&amp;shift=${shift}`);
        return await response.json();
    }
    
    // Create a new task
    async createTask(taskData) {
        const csrfToken = document.querySelector('meta[name=&quot;csrf-token&quot;]').getAttribute('content');
        
        const response = await fetch('/actions/porter/tasks/create-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify(taskData)
        });
        
        return await response.json();
    }
    
    // Update an existing task
    async updateTask(taskId, taskData) {
        const csrfToken = document.querySelector('meta[name=&quot;csrf-token&quot;]').getAttribute('content');
        
        const response = await fetch(`/actions/porter/tasks/update-task?id=${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify(taskData)
        });
        
        return await response.json();
    }
    
    // Complete a task
    async completeTask(taskId, completionTime) {
        const csrfToken = document.querySelector('meta[name=&quot;csrf-token&quot;]').getAttribute('content');
        
        const response = await fetch(`/actions/porter/tasks/complete-task`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({
                id: taskId,
                timeCompleted: completionTime
            })
        });
        
        return await response.json();
    }
    
    // Archive current shift
    async archiveShift(date, shift) {
        const csrfToken = document.querySelector('meta[name=&quot;csrf-token&quot;]').getAttribute('content');
        
        const response = await fetch('/actions/porter/tasks/archive-shift', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({
                date,
                shift
            })
        });
        
        return await response.json();
    }
}

// Export a singleton instance
window.porterApi = new PorterApi();
</code></pre>

<h2 id="phase3:implementcustommodulecomponents">Phase 3: Implement Custom Module Components</h2>

<h3 id="step1:installmodule">Step 1: Install Module</h3>

<p>When the module structure is generated, ensure the module is bootstrapped in <code>config/app.php</code>:</p>

<pre><code class="php">return [
    'modules' =&gt; [
        'porter' =&gt; \modules\porter\Porter::class,
    ],
    'bootstrap' =&gt; ['porter'],
];
</code></pre>

<h3 id="step2:defineelementtypes">Step 2: Define Element Types</h3>

<p>Example staff element implementation:</p>

<pre><code class="php">&lt;?php

namespace modules\porter\elements;

use Craft;
use craft\base\Element;
use craft\elements\db\ElementQueryInterface;
use modules\porter\elements\db\StaffQuery;
use modules\porter\records\StaffRecord;

class Staff extends Element
{
    public $name;
    public $email;
    public $active = true;

    public static function displayName(): string
    {
        return 'Staff';
    }

    public static function find(): ElementQueryInterface
    {
        return new StaffQuery(static::class);
    }

    public function afterSave(bool $isNew): void
    {
        if ($isNew) {
            \Craft::$app-&gt;db-&gt;createCommand()
                -&gt;insert(StaffRecord::tableName(), [
                    'id' =&gt; $this-&gt;id,
                    'name' =&gt; $this-&gt;name,
                    'email' =&gt; $this-&gt;email,
                    'active' =&gt; $this-&gt;active,
                ])
                -&gt;execute();
        } else {
            \Craft::$app-&gt;db-&gt;createCommand()
                -&gt;update(StaffRecord::tableName(), [
                    'name' =&gt; $this-&gt;name,
                    'email' =&gt; $this-&gt;email,
                    'active' =&gt; $this-&gt;active,
                ], ['id' =&gt; $this-&gt;id])
                -&gt;execute();
        }

        parent::afterSave($isNew);
    }

    // Other element methods...
}
</code></pre>

<h3 id="step3:implementcontrolleractions">Step 3: Implement Controller Actions</h3>

<p>Example tasks controller:</p>

<pre><code class="php">&lt;?php

namespace modules\porter\controllers;

use Craft;
use craft\web\Controller;
use modules\porter\elements\Task;
use yii\web\Response;

class TasksController extends Controller
{
    protected array|bool|int $allowAnonymous = self::ALLOW_ANONYMOUS_NEVER;

    public function actionGetPendingTasks(): Response
    {
        $this-&gt;requireAcceptsJson();
        
        $date = Craft::$app-&gt;request-&gt;getQueryParam('date');
        $shift = Craft::$app-&gt;request-&gt;getQueryParam('shift');
        
        $pendingTasks = Task::find()
            -&gt;status('pending')
            -&gt;date($date)
            -&gt;shift($shift)
            -&gt;all();
            
        $result = [];
        foreach ($pendingTasks as $task) {
            $result[] = [
                'id' =&gt; $task-&gt;id,
                'timeReceived' =&gt; $task-&gt;timeReceived,
                'fromDepartment' =&gt; $task-&gt;fromDepartment-&gt;title ?? null,
                'toDepartment' =&gt; $task-&gt;toDepartment-&gt;title ?? null,
                'jobCategory' =&gt; $task-&gt;jobCategory-&gt;title ?? null,
                'itemType' =&gt; $task-&gt;itemType-&gt;title ?? null,
                'transportType' =&gt; $task-&gt;transportType,
                'staffName' =&gt; $task-&gt;assignedStaff-&gt;name ?? null,
                'timeAllocated' =&gt; $task-&gt;timeAllocated,
            ];
        }
        
        return $this-&gt;asJson($result);
    }
    
    // Other controller actions...
}
</code></pre>

<h2 id="phase4:datamigrationandtesting">Phase 4: Data Migration and Testing</h2>

<ol>
<li>Create a migration to populate initial data from your mock data</li>
<li>Test each API endpoint</li>
<li>Test the UI with real Craft data</li>
<li>Implement validation and error handling</li>
</ol>

<h2 id="nextsteps">Next Steps</h2>

<p>Once this structure is implemented, you&#8217;ll have a fully functional Craft CMS backend for your Porter Task Management application. The integration with frontend code will be seamless, while also providing you with a robust admin interface to manage all your data.</p>

<p>In future phases, you could consider:</p>

<ol>
<li>Implementing user permissions</li>
<li>Adding dashboard widgets for staff and task statistics</li>
<li>Creating more advanced reporting features</li>
<li>Implementing mobile app integration with the same API</li>
</ol>

</body>
</html>

